{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "342eac11_2e0cfb39",
        "filename": "lib/el3_runtime/aarch64/context.S",
        "patchSetId": 2
      },
      "lineNbr": 369,
      "author": {
        "id": 1000228
      },
      "writtenOn": "2022-02-14T17:48:53Z",
      "side": 0,
      "message": "I\u0027m afraid this won\u0027t work as is without a proper Hafnium fix.\nHafnium inits this register once at boot time.\nVSTCR_EL2 is reset on warm reboots.",
      "range": {
        "startLine": 369,
        "startChar": 5,
        "endLine": 369,
        "endChar": 14
      },
      "revId": "cbadfe694207c9bf0c8f0e639b56666f47a4c712",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e2bc605c_96119f68",
        "filename": "lib/el3_runtime/aarch64/context.S",
        "patchSetId": 2
      },
      "lineNbr": 369,
      "author": {
        "id": 1000219
      },
      "writtenOn": "2022-02-15T14:20:45Z",
      "side": 0,
      "message": "Ok, I will hold off this patch for now.",
      "parentUuid": "342eac11_2e0cfb39",
      "range": {
        "startLine": 369,
        "startChar": 5,
        "endLine": 369,
        "endChar": 14
      },
      "revId": "cbadfe694207c9bf0c8f0e639b56666f47a4c712",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2ec548b1_b4f397eb",
        "filename": "lib/el3_runtime/aarch64/context.S",
        "patchSetId": 2
      },
      "lineNbr": 369,
      "author": {
        "id": 1000114
      },
      "writtenOn": "2022-02-18T07:18:04Z",
      "side": 0,
      "message": "Olivier, out of curiosity, what is the issue? If it is not saved and restored, how does it affect hafnium?",
      "parentUuid": "e2bc605c_96119f68",
      "range": {
        "startLine": 369,
        "startChar": 5,
        "endLine": 369,
        "endChar": 14
      },
      "revId": "cbadfe694207c9bf0c8f0e639b56666f47a4c712",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9f9c73c6_8146872a",
        "filename": "lib/el3_runtime/aarch64/context.S",
        "patchSetId": 2
      },
      "lineNbr": 369,
      "author": {
        "id": 1000228
      },
      "writtenOn": "2022-02-21T13:58:23Z",
      "side": 0,
      "message": "When a core resumes from suspend a number of registers (or register fields) get reset. This is the case of VSTCR_EL2 which is only initialized once by Hafnium https://git.trustedfirmware.org/hafnium/hafnium.git/tree/src/arch/aarch64/hypervisor/hypervisor_entry.S#n210\nHafnium doesn\u0027t go through a full core reinit on core resume. Next entry into the SPMC restoring a vCPU crashes because this S2 configuration register is lost.\nPrior to this change this was covered by EL3 restoring EL2 registers including \u0027secure only\u0027 registers.",
      "parentUuid": "2ec548b1_b4f397eb",
      "range": {
        "startLine": 369,
        "startChar": 5,
        "endLine": 369,
        "endChar": 14
      },
      "revId": "cbadfe694207c9bf0c8f0e639b56666f47a4c712",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e9c3ef95_e87fa18c",
        "filename": "lib/el3_runtime/aarch64/context.S",
        "patchSetId": 2
      },
      "lineNbr": 369,
      "author": {
        "id": 1000114
      },
      "writtenOn": "2022-02-22T03:19:40Z",
      "side": 0,
      "message": "Understood. This is really missing functionality in Hafnium right? cannot (and likely should not) depend on EL3 to save and restore stuff no?",
      "parentUuid": "9f9c73c6_8146872a",
      "range": {
        "startLine": 369,
        "startChar": 5,
        "endLine": 369,
        "endChar": 14
      },
      "revId": "cbadfe694207c9bf0c8f0e639b56666f47a4c712",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a957e7d9_31afe3ff",
        "filename": "lib/el3_runtime/aarch64/context.S",
        "patchSetId": 2
      },
      "lineNbr": 369,
      "author": {
        "id": 1000228
      },
      "writtenOn": "2022-02-23T07:16:51Z",
      "side": 0,
      "message": "Yes with some nuance. The easy fix would be to consider VSTCR_EL2/VTCR_EL2 to become part of SP state (rather than Hafnium state) and be added to SP context save/restore (just like VSTTBR_EL2/VTTBR_EL2 are). This is a bit suboptimal because VTCR_EL2/VSTCR_EL2 are fixed once for all at boot. So this is creating invariant copies per VM.\nOn the other hand, we really want Hafnium EL2 state to be preserved accross SMC calls e.g. TTBR0_EL2. So this is fine tuning in terms of which registers need to be retained by the EL3 save/restore routine (I guess that\u0027s what you meant anyways?).",
      "parentUuid": "e9c3ef95_e87fa18c",
      "range": {
        "startLine": 369,
        "startChar": 5,
        "endLine": 369,
        "endChar": 14
      },
      "revId": "cbadfe694207c9bf0c8f0e639b56666f47a4c712",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d3f9d829_587039c3",
        "filename": "lib/el3_runtime/aarch64/context.S",
        "patchSetId": 2
      },
      "lineNbr": 369,
      "author": {
        "id": 1000114
      },
      "writtenOn": "2022-02-23T22:41:29Z",
      "side": 0,
      "message": "yep, that answers my question. THanks Olivier.",
      "parentUuid": "a957e7d9_31afe3ff",
      "range": {
        "startLine": 369,
        "startChar": 5,
        "endLine": 369,
        "endChar": 14
      },
      "revId": "cbadfe694207c9bf0c8f0e639b56666f47a4c712",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    }
  ]
}