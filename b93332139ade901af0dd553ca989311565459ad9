{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "f8a84697_f811bfe9",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 8,
      "author": {
        "id": 1000103
      },
      "writtenOn": "2023-09-13T13:01:40Z",
      "side": 1,
      "message": "Hi Robin,\nA bit more explanation about how it is working could be good here.\nShould the tools/cert_create/src/main.c::print_help() be updated?\nAnd maybe docs/design/trusted-board-boot.rst?\nSandrine, do you know which other parts of the doc should be updated too?",
      "revId": "b93332139ade901af0dd553ca989311565459ad9",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6d4176ae_41ddb959",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 8,
      "author": {
        "id": 1001111
      },
      "writtenOn": "2023-09-14T09:07:13Z",
      "side": 1,
      "message": "Hi Yann,\nYou are right, updating the help/docs is required.\nBefore putting more work into this, I\u0027d like to note that openssl deprecated support for the engine API since version 3.0. Linking this with openssl \u003e\u003d 3.0 will give warnings.\nI did push this change because I believe cert_create without the ability to use a HSM is not usable in a production environment.\nIt would be better to add pkcs11 support with the new openSSL provider API.\nI was hoping this push might get something rolling ;)",
      "parentUuid": "f8a84697_f811bfe9",
      "revId": "b93332139ade901af0dd553ca989311565459ad9",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "644cb11e_70ebad11",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 8,
      "author": {
        "id": 1000043
      },
      "writtenOn": "2023-09-18T11:06:46Z",
      "side": 1,
      "message": "Hi,\n\nThanks for the patch! I agree it would be great if the cert_create tool supported HSMs. In fact, you\u0027re not the first person to raise interest on this topic!\n\nAs I understand, this patch only provides one piece of PKCS#11 support, namely the ability to retrieve private keys (optionally protected by a PIN) from an HSM over PKCS#11. I imagine that a complete PKCS#11 solution would also support things like signing a payload (such that private keys never leave the HSM). Is my understanding correct?\n\nRegarding documentation, I suspect there is not much to update. We do not have a dedicated documentation page for the cert_create tool. Perhaps it\u0027s time to create one? This would go under the tools section here:\n\nhttps://trustedfirmware-a.readthedocs.io/en/latest/tools/index.html\n\nWe could mention there that cert_create supports interfacing with an HSM through PCKS#11. Also worth saying that the tool accepts receiving the PIN required to unlock access to private keys within the HSM through the \"PKCS11_PIN\" environment variable.\n\ndocs/design/trusted-board-boot.rst describes the trusted boot design in the firmware itself so it\u0027s irrelevant here, as we\u0027re doing changes to the host tools only.\n\nI am more worried about the incompatibility of this patch with OpenSSL 3.0... Although TF-A tools currently support both OpenSSL 1.1.1+ and 3.0, the latter is the default version used by TF-A OpenCI. So I think this patch would not pass the CI tests as is. Moreover, I believe the plan would be to deprecate OpenSSL 1.x API usage in TF-A tools in the future, when OpenSSL 3.0 is more broadly supported across Linux distros by default.\n\nRobin, how much would it take to support the new OpenSSL provider API instead? Is it a lot more complex than the old engine API? Is that why you went for the old API in the first place? Would you be willing to contribute another patch using the new provider API?",
      "parentUuid": "6d4176ae_41ddb959",
      "revId": "b93332139ade901af0dd553ca989311565459ad9",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "05a2ea5b_99c9596b",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 8,
      "author": {
        "id": 1001111
      },
      "writtenOn": "2023-09-18T13:00:43Z",
      "side": 1,
      "message": "Hi Sandrine,\n\nThis patch provides full PKCS11 support. Operations (like signing) used with the EVP_PKEY object retreived through the ENGINE_load_private_key() are provided by the engine as well, thus will go to the HSM. I\u0027m using create_cert with a ROT private key on a HSM for a while now. But I can store all keys required for the TBB on the HSM, and just have to supply their pkcs11 uri (i.e. \"pkcs11:object\u003dtos-key\") instead of a filename for it to work.\n\nPKCS11_PIN is optional. If not provided in the environment the engine (libp11) will ask you to provide the pin it on stdin.\n\nI figured the openssl3 deprecation would be an issue. I have to say a LOT of tooling is stil using the engine API (libp11) for pkcs11 today. I added engine support because I\u0027m familliar with it.\n\nI currently don\u0027t have time to dive into the provider API and update the code accordingly. But I\u0027ll have to do it in the near future anyways... If I do I\u0027ll submit another patch.",
      "parentUuid": "644cb11e_70ebad11",
      "revId": "b93332139ade901af0dd553ca989311565459ad9",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1cb074b3_8cc3de9f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 8,
      "author": {
        "id": 1000043
      },
      "writtenOn": "2023-09-19T12:54:50Z",
      "side": 1,
      "message": "Hi Robin,\n\nThanks for your answer, this clarifies a lot of things for me. In particular, I was unaware that all operations would go through the engine for an EVP_PKEY obtained through the engine. That\u0027s great! I\u0027d never thought adding full PKCS#11 support to the cert_create tool would be that straightforward!\n\nI had figured out that the PKCS11_PIN was optional - since getenv() is behind a test condition - but if not provided, I thought access to private keys within the HSM was just unprotected (which, now that I think more about it, would sound unsafe!). So thanks for clarifying that as well.\n\nRegarding the openssl1 deprecation, I guess we could accept your patch for the time being and keep it until we actually do the deprecation. Clearly, this feature is useful to you in its current form, and given what you say about the pkcs11 tooling landscape today, it\u0027s likely it would be useful to others as well. I imagine this could influence the whole openssl1 deprecation decision.\n\nAnd if you can contribute the openssl3/provider API version in the future, that would be even better!\n\nIn summary, it looks to me as if this patch is feature-complete, as far as cert_create source code is concerned. What we are missing are:\n- some documentation, as discussed above.\n- a more elaborate commit message.\n- integration into TF-A build system to drive cert_create tool for PKCS#11-compliant HSMs. I imagine we would need a new flag such as -pkcs11 to run the tool in this mode, and perhaps some argument plumbing to pass \"pkcs11:object\u003dtos-key\" type of strings? Does that make sense?",
      "parentUuid": "05a2ea5b_99c9596b",
      "revId": "b93332139ade901af0dd553ca989311565459ad9",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "981c0454_813538e0",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 8,
      "author": {
        "id": 1001111
      },
      "writtenOn": "2023-09-19T15:29:22Z",
      "side": 1,
      "message": "Hi Sandrine,\n\nI\u0027ve re-submitted the patch. The things I\u0027ve changed:\n\n* Created a separate patch[1] for the removal of the \u0027k\u0027 pointer in key_load()\n* Updated the all key releated help_msg so they mention the ability to supply a pkcs11 uri.\n* Added a commit message\n* Added a call to ENGINE_free() in key_load_pkcs11() on failure\n\nI\u0027m not sure that you mean with you last point.\n\n1: https://review.trustedfirmware.org/c/TF-A/trusted-firmware-a/+/23438",
      "parentUuid": "1cb074b3_8cc3de9f",
      "revId": "b93332139ade901af0dd553ca989311565459ad9",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "35691ea6_fc9b3afa",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1000043
      },
      "writtenOn": "2023-09-13T12:38:39Z",
      "side": 1,
      "message": "Jimmy is on leave right now so he won\u0027t be able to review this patch for some time. Adding a couple more reviewers on this patch in case they get around to taking a look before myself.",
      "revId": "b93332139ade901af0dd553ca989311565459ad9",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e78e1cde_8fb4e5c5",
        "filename": "tools/cert_create/src/key.c",
        "patchSetId": 1
      },
      "lineNbr": 204,
      "author": {
        "id": 1000043
      },
      "writtenOn": "2023-09-19T12:54:50Z",
      "side": 1,
      "message": "Don\u0027t we need to call ENGINE_free() in all error code paths starting from here?",
      "revId": "b93332139ade901af0dd553ca989311565459ad9",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2d78b289_f20e160c",
        "filename": "tools/cert_create/src/key.c",
        "patchSetId": 1
      },
      "lineNbr": 204,
      "author": {
        "id": 1001111
      },
      "writtenOn": "2023-09-19T15:29:22Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "e78e1cde_8fb4e5c5",
      "revId": "b93332139ade901af0dd553ca989311565459ad9",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1adf997f_1599994f",
        "filename": "tools/cert_create/src/key.c",
        "patchSetId": 1
      },
      "lineNbr": 232,
      "author": {
        "id": 1000103
      },
      "writtenOn": "2023-09-13T13:01:40Z",
      "side": 1,
      "message": "Maybe this should be explained in commit message, as it is not directly related to PKCS11. From what I\u0027ve seen in pem_read_bio_key_decoder(), this doesn\u0027t change a lot, and avoids a free and copy. It also avoids having a temporary variable here.",
      "revId": "b93332139ade901af0dd553ca989311565459ad9",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ad4aefd5_6ac17e31",
        "filename": "tools/cert_create/src/key.c",
        "patchSetId": 1
      },
      "lineNbr": 232,
      "author": {
        "id": 1001111
      },
      "writtenOn": "2023-09-14T09:07:13Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "1adf997f_1599994f",
      "revId": "b93332139ade901af0dd553ca989311565459ad9",
      "serverId": "8f6f209b-db1a-4cbf-aa44-c8bc30e9bfda"
    }
  ]
}